<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª (APIé€£å‹•ç‰ˆ)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 700px;
            margin: 40px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1a73e8;
            margin-bottom: 30px;
        }
        #quiz-status {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #555;
        }
        #question-area {
            min-height: 100px;
            margin-bottom: 30px;
        }
        #question-text {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 20px;
            line-height: 1.6;
            padding: 10px;
            border-left: 5px solid #1a73e8;
            text-align: left;
        }
        #choices button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        #choices button:hover:not(:disabled) {
            background-color: #e0e9f7;
            border-color: #1a73e8;
        }
        #choices button:disabled {
            cursor: default;
            opacity: 0.8;
        }
        .correct {
            background-color: #c8e6c9 !important;
            border-color: #4caf50 !important;
            font-weight: bold;
        }
        .incorrect {
            background-color: #ffcdd2 !important;
            border-color: #f44336 !important;
        }
        #feedback {
            font-size: 1.8em;
            margin: 20px 0 10px 0;
            font-weight: bold;
            min-height: 30px;
        }
        #explanation {
            font-size: 1em;
            line-height: 1.6;
            margin-top: 10px;
            padding: 15px;
            background-color: #f1f8e9;
            border-radius: 5px;
            text-align: left;
            display: none; /* æœ€åˆã¯éè¡¨ç¤º */
        }
        #next-button {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            display: none;
        }
        #next-button:hover {
            background-color: #388e3c;
        }
        #results-area {
            margin-top: 30px;
            padding: 20px;
            background-color: #e0f2f1;
            border-radius: 10px;
            display: none;
        }
        #results-area h2 {
            color: #00796b;
        }
        #results-area p {
            font-size: 1.1em;
            line-height: 1.8;
            margin-top: 15px;
        }
        /* èª­ã¿è¾¼ã¿ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</h1>

    <div id="quiz-status"></div>

    <div id="quiz-container">
        <div id="question-area">
            <p id="question-text">ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>

        <div id="choices">
            </div>

        <p id="feedback"></p>
        <div id="explanation"></div>

        <button id="next-button">æ¬¡ã®å•é¡Œã¸</button>
    </div>

    <div id="results-area">
        <h2>ğŸ‰ ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼ ğŸ‰</h2>
        <p id="score-text"></p>
        <p id="comment-text"></p>
        <button onclick="location.reload()" style="padding:10px 20px; font-size:1em; margin-top:15px; cursor:pointer;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
    </div>
</div>

<script>
// --- è¨­å®š: GASã®Webã‚¢ãƒ—ãƒªURL ---
const API_URL = "https://script.google.com/macros/s/AKfycbz56xO3R78V8farGrvCl3ZGVkpJf2l5IyNM4XwyLF9TsQSHQtBMqZct0b2-BvDCqEPaQg/exec";

// --- ã‚¯ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯ ---
const TOTAL_QUESTIONS = 10;
let quizData = [];
let questionSet = [];
let currentQuestionIndex = 0;
let score = 0;

// DOMè¦ç´ ã®å–å¾—
const questionTextElem = document.getElementById('question-text');
const choicesElem = document.getElementById('choices');
const feedbackElem = document.getElementById('feedback');
const explanationElem = document.getElementById('explanation'); // è§£èª¬ç”¨
const nextButton = document.getElementById('next-button');
const quizStatusElem = document.getElementById('quiz-status');
const quizContainer = document.getElementById('quiz-container');
const resultsArea = document.getElementById('results-area');
const scoreTextElem = document.getElementById('score-text');
const commentTextElem = document.getElementById('comment-text');

// é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨åˆæœŸåŒ– (Async/Awaitã‚’ä½¿ç”¨)
async function initializeQuiz() {
    try {
        questionTextElem.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ä¸­...";
        questionTextElem.classList.add("loading");

        // GASã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        constresponse = await fetch(API_URL);
        
        // GASã®Webã‚¢ãƒ—ãƒªã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¯è‡ªå‹•è¿½å¾“ã•ã‚Œã¾ã™
        if (!constresponse.ok) {
            throw new Error(`HTTP error! status: ${constresponse.status}`);
        }
        
        const data = await constresponse.json();
        
        // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼
        if (!data || data.length === 0) {
            throw new Error("ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");
        }

        quizData = data;
        startQuiz();

    } catch (error) {
        console.error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        questionTextElem.textContent = "ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã‹ã€ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
        questionTextElem.classList.remove("loading");
    }
}

function startQuiz() {
    questionTextElem.classList.remove("loading");
    
    // ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®ãƒã‚§ãƒƒã‚¯
    if (quizData.length < TOTAL_QUESTIONS) {
        questionTextElem.textContent = "ã‚¨ãƒ©ãƒ¼: å•é¡Œæ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚";
        return;
    }

    // å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«10å•é¸æŠ
    shuffleArray(quizData);
    questionSet = quizData.slice(0, TOTAL_QUESTIONS);

    currentQuestionIndex = 0;
    score = 0;
    
    // UIã‚’ãƒªã‚»ãƒƒãƒˆ
    quizContainer.style.display = 'block';
    resultsArea.style.display = 'none';
    
    displayQuestion();
}

// ç¾åœ¨ã®å•é¡Œã‚’è¡¨ç¤º
function displayQuestion() {
    if (currentQuestionIndex >= TOTAL_QUESTIONS) {
        showResults();
        return;
    }

    const q = questionSet[currentQuestionIndex];
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°
    quizStatusElem.textContent = `ç¬¬ ${currentQuestionIndex + 1} å• / å…¨ ${TOTAL_QUESTIONS} å•`;

    // å•é¡Œæ–‡ã®è¡¨ç¤º
    questionTextElem.textContent = q.Question;
    
    // é¸æŠè‚¢ã‚¨ãƒªã‚¢ã®ã‚¯ãƒªã‚¢
    choicesElem.innerHTML = '';
    
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨è§£èª¬ã‚’ãƒªã‚»ãƒƒãƒˆãƒ»éè¡¨ç¤º
    feedbackElem.textContent = '';
    explanationElem.style.display = 'none';
    explanationElem.textContent = '';
    nextButton.style.display = 'none';

    // é¸æŠè‚¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™
    const choicesMap = {
        'A': q.Choice_A,
        'B': q.Choice_B,
        'C': q.Choice_C,
        'D': q.Choice_D
    };
    
    const choiceKeys = ['A', 'B', 'C', 'D'];

    choiceKeys.forEach(key => {
        const button = document.createElement('button');
        button.textContent = `${key}: ${choicesMap[key]}`;
        button.dataset.answerKey = key;
        // é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        button.onclick = () => checkAnswer(button, q.Correct_Answer_Key, q.Explanation);
        choicesElem.appendChild(button);
    });
}

// å›ç­”ã®ãƒã‚§ãƒƒã‚¯
function checkAnswer(selectedButton, correctKey, explanationText) {
    const selectedKey = selectedButton.dataset.answerKey;
    const allButtons = choicesElem.querySelectorAll('button');

    // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
    allButtons.forEach(btn => btn.disabled = true);

    if (selectedKey === correctKey) {
        score++;
        feedbackElem.textContent = 'æ­£è§£â˜†å½¡';
        feedbackElem.style.color = '#4caf50';
        selectedButton.classList.add('correct');
    } else {
        feedbackElem.textContent = 'æ®‹å¿µï¼';
        feedbackElem.style.color = '#f44336';
        selectedButton.classList.add('incorrect');
        
        // æ­£è§£ã®ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦æ•™ãˆã‚‹
        const correctButton = Array.from(allButtons).find(btn => btn.dataset.answerKey === correctKey);
        if (correctButton) {
            correctButton.classList.add('correct');
        }
    }

    // è§£èª¬ã‚’è¡¨ç¤º (JSONãƒ‡ãƒ¼ã‚¿ã«ExplanationãŒã‚ã‚‹å ´åˆ)
    if (explanationText) {
        explanationElem.innerHTML = "<strong>ã€è§£èª¬ã€‘</strong><br>" + explanationText;
        explanationElem.style.display = 'block';
    }
    
    nextButton.style.display = 'block';
}

// æ¬¡ã®å•é¡Œã¸
nextButton.addEventListener('click', () => {
    currentQuestionIndex++;
    displayQuestion();
});

// çµæœè¡¨ç¤º
function showResults() {
    quizContainer.style.display = 'none';
    resultsArea.style.display = 'block';
    quizStatusElem.textContent = ""; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¶ˆã™

    const correctRate = Math.round((score / TOTAL_QUESTIONS) * 100);
    let comment = "";

    if (correctRate === 100) {
        comment = "ç´ æ™´ã‚‰ã—ã„ï¼ã‚ãªãŸã¯ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®çŸ¥è­˜ã‚’å®Œç’§ã«ãƒã‚¹ã‚¿ãƒ¼ã—ã¦ã„ã¾ã™ï¼ğŸ‰";
    } else if (correctRate >= 80) {
        comment = "ãŠè¦‹äº‹ï¼é«˜ã„æ­£è§£ç‡ã§ã™ã€‚ã‚ã¨å°‘ã—ã§æº€ç‚¹ï¼ã“ã®èª¿å­ã§é ‘å¼µã£ã¦ãã ã•ã„ï¼ğŸ’ª";
    } else if (correctRate >= 50) {
        comment = "ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸï¼åŠåˆ†ä»¥ä¸Šæ­£è§£ã§ã™ã€‚é–“é•ãˆãŸéƒ¨åˆ†ã‚’è¦‹ç›´ã—ã¦ã€ã•ã‚‰ã«çŸ¥è­˜ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ï¼ğŸ“š";
    } else {
        comment = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚æ¬¡å›ã¯ã‚‚ã£ã¨é«˜å¾—ç‚¹ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼ç¹°ã‚Šè¿”ã—æŒ‘æˆ¦ã™ã‚‹ã“ã¨ãŒæˆåŠŸã¸ã®éµã§ã™ï¼ğŸ”‘";
    }

    scoreTextElem.innerHTML = `æ­£è§£æ•°: <span style="font-size: 1.5em; color: #1a73e8;">${score}</span> å• / å…¨ ${TOTAL_QUESTIONS} å•<br>æ­£è§£ç‡: <span style="font-size: 1.5em; color: #1a73e8;">${correctRate}%</span>`;
    commentTextElem.textContent = comment;
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
document.addEventListener('DOMContentLoaded', initializeQuiz);
</script>

</body>
</html>
